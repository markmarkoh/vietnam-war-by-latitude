<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>
<style>
#map { height: 100vh; }
</style>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

<div id="map"></div>
<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoidGhvci1tYXJrIiwiYSI6ImNrY3IzbnpxMzBnc3QyeXBkZmFicHhhNXQifQ.levs2UY_u0y9PcCLKJIpsA';
  const map = new mapboxgl.Map({
    container: 'map', // container ID
    style: 'mapbox://styles/thor-mark/ckcs2f18w1fk41imj7dphkl04',
    center: [105, 21], // starting position [lng, lat]
    zoom: 5 // starting zoom
  });
  var container = map.getCanvasContainer();
  var svg = d3
    .select(container)
    .append("svg")
    .attr("width", "100%")
    .attr("height", "1000")
    .attr("id", "svg-container")
    .style("position", "absolute")
    .style("z-index", 2);

  function project(d) {
    return map.project(new mapboxgl.LngLat(d[0], d[1]));
  }

  var data = [
    [105, 21],
    [105.3, 21.9],
    [108, 24]
  ];

  /*var dots = svg
    .selectAll("circle")
    .data(data)
    .enter()
    .append("circle")
    .attr("r", 20)
    .style("fill", "#ff0000"); */

  _data().then(data => {
      window.data = data;
      render();
    })
  function render() {
    const margin = _margin();
    const width = _width();
    const height = _height();
    const overlap = _overlap();
    const x = _x(margin, width);
    const y = _y(margin, height);
    const z = _z(overlap, y);
    const xAxis = _xAxis(height, margin, x, width);
    const yAxis = _yAxis(margin, y);
    const area = _area(x, z);
    const line = _line(area);
    _chart(d3, xAxis, yAxis, y, area, line);
    /*dots
      .attr("cx", function (d) {
        return project(d).x;
      })
      .attr("cy", function (d) {
        return project(d).y;
      });*/
  }

  map.on("viewreset", render);
  map.on("move", render);
  map.on("moveend", render);

 function _chart(d3,xAxis,yAxis,y,area,line)
{
  const svg = d3.select("#svg-container");

  svg.append("g")
      .call(xAxis);

  svg.append("g")
      .call(yAxis);
  
  const group = svg.append("g")
    .selectAll("g")
    .data(data.series)
    .join("g")
      .attr("transform", d => `translate(0,${y(d.lat) + 1})`);

  group.append("path")
      .attr("fill", "#ddd")
      .attr("fill-opacity", 0.8)
      .attr("d", d => area(d.values));

  group.append("path")
      .attr("fill", "none")
      .attr("stroke", "black")
      .attr("d", d => line(d.values));

  return svg.node();
}


function _overlap(){return(
8
)}

function _height(){return(
data.series.length * 25
)}

function _width() {
    return 800
  }

function _margin(){return(
{top: 40, right: 20, bottom: 30, left: 120}
)}

function _x(margin,width){return(
d3.scaleTime()
    .domain(d3.extent(data.dates))
    .range([margin.left, width - margin.right])
)}

function _y(margin,height){return(
d3.scalePoint()
    .domain(data.series.map(d => d.lat))
    .range([margin.top, height - margin.bottom])
)}

function _z(overlap,y){return(
d3.scaleLinear()
    .domain([0, d3.max(data.series, d => d3.max(d.values))]).nice()
    .range([0, -overlap * y.step()])
)}

function _xAxis(height,margin,x,width){return(
g => g
  .attr("transform", `translate(0,${height - margin.bottom})`)
  .call(d3.axisBottom(x)
      .ticks(width / 80)
      .tickSizeOuter(0))
)}

function _yAxis(margin, y){return(
g => g
    .attr("transform", `translate(${margin.left},0)`)
    .call(d3.axisLeft(y).tickSize(0).tickPadding(4))
    .call(g => g.select(".domain").remove())
)}

function _area(x,z){return(
d3.area()
    .curve(d3.curveBasis)
    .defined(d => !isNaN(d))
    .x((d, i) => x(data.dates[i]))
    .y0(0)
    .y1(d => z(d))
)}

function _line(area){return(
area.lineY1()
)}

async function _data() {
    const data = await d3.csv("thor_grouped_month.csv", d3.autoType);
    console.log("data was", data);
    const dates = Array.from(d3.group(data, d => +d.month).keys()).sort(d3.ascending);
    return {
      dates: dates.map(d => new Date(d)),
      series: d3.groups(data, d => d.lat).map(([lat, values]) => {
        if (lat < 9 || lat > 25) return null;
        const value = new Map(values.map(d => [+d.month, d.n]));
        return {lat, values: dates.map(d => value.get(d) || 0)};
      }).filter(s => !!s).sort((a,b) => b.lat - a.lat)
    };
}



</script>
</body>
</html>
